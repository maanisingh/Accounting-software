name: PR Quality Checks

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '22.x'

jobs:
  # Backend Quality Checks
  backend-quality:
    name: Backend Quality Gate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint || true
        continue-on-error: true

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Validate Prisma Schema
        run: npx prisma validate

      - name: Check Prisma Migrations
        run: |
          if [ -d "prisma/migrations" ]; then
            echo "‚úÖ Migrations directory exists"
            ls -la prisma/migrations/
          else
            echo "‚ö†Ô∏è  No migrations directory found"
          fi

      - name: Run Tests
        run: npm test || true
        continue-on-error: true
        env:
          NODE_ENV: test

      - name: Security Audit
        run: npm audit --audit-level=moderate || true
        continue-on-error: true

  # Frontend Quality Checks
  frontend-quality:
    name: Frontend Quality Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build check
        run: npm run build || true
        continue-on-error: true
        env:
          NODE_ENV: production

      - name: Security Audit
        run: npm audit --audit-level=moderate || true
        continue-on-error: true

  # Code Size Check
  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build || true
        continue-on-error: true

      - name: Check bundle size
        run: |
          if [ -d "dist" ]; then
            echo "üì¶ Bundle Size:"
            du -sh dist/
            echo ""
            echo "üìä Detailed breakdown:"
            du -h dist/* | sort -hr
          fi

  # Summary
  quality-summary:
    name: Quality Check Summary
    needs: [backend-quality, frontend-quality, size-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## PR Quality Check Summary"
          echo ""
          echo "Backend: ${{ needs.backend-quality.result }}"
          echo "Frontend: ${{ needs.frontend-quality.result }}"
          echo "Size Check: ${{ needs.size-check.result }}"
          echo ""
          if [ "${{ needs.backend-quality.result }}" == "success" ] && [ "${{ needs.frontend-quality.result }}" == "success" ]; then
            echo "‚úÖ All quality checks passed!"
          else
            echo "‚ö†Ô∏è  Some checks completed with warnings (non-blocking)"
          fi
