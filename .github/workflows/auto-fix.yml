name: Auto-Fix Issues

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

env:
  NODE_VERSION: '22.x'

jobs:
  auto-fix:
    name: Automatically Fix Common Issues
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure Git
        run: |
          git config --global user.name 'ZirakBook Bot'
          git config --global user.email 'bot@zirakbook.com'

      # Backend Auto-fixes
      - name: Fix Backend Issues
        run: |
          cd backend

          # Install dependencies
          npm install || true

          # Update dependencies (patch versions only)
          npm update --save || true

          # Fix security vulnerabilities
          npm audit fix || true

          # Generate Prisma client
          npx prisma generate || true

          # Format Prisma schema
          npx prisma format || true

          cd ..

      # Frontend Auto-fixes
      - name: Fix Frontend Issues
        run: |
          # Install dependencies
          npm install || true

          # Update dependencies (patch versions only)
          npm update --save || true

          # Fix security vulnerabilities
          npm audit fix || true

      # Check for changes
      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected:"
            git status -s
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes needed"
          fi

      # Commit and push changes
      - name: Commit auto-fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git add .
          git commit -m "chore: Auto-fix dependencies and formatting

          ðŸ¤– Automated fixes applied:
          - Updated dependencies (patch versions)
          - Fixed security vulnerabilities
          - Regenerated Prisma client
          - Formatted code

          Generated by GitHub Actions Auto-Fix workflow"

      - name: Push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Auto-fixes applied and pushed"
          else
            echo "âœ… No fixes needed - everything is up to date"
          fi
