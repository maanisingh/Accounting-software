name: Deployment Doctor (Auto-Heal)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [deployment_failed]

env:
  NODE_VERSION: '22.x'

jobs:
  diagnose-and-fix:
    name: Diagnose & Fix Deployment Issues
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure Git
        run: |
          git config --global user.name 'ZirakBook Deployment Doctor'
          git config --global user.email 'deploy-doctor@zirakbook.com'

      - name: Diagnose Backend Issues
        id: backend-diagnosis
        run: |
          cd backend
          echo "ðŸ” Diagnosing backend issues..."

          # Check if package.json exists
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found!"
            exit 1
          fi

          # Check if nixpacks.toml has correct configuration
          if [ ! -f "nixpacks.toml" ]; then
            echo "âš ï¸  nixpacks.toml missing - creating..."
            cat > nixpacks.toml << 'NIXEOF'
[phases.setup]
nixPkgs = ['nodejs_22', 'openssl']

[phases.install]
cmds = ['npm install --legacy-peer-deps']

[phases.build]
cmds = ['npx prisma generate']

[start]
cmd = 'npx prisma migrate deploy && node src/server.js'
NIXEOF
            git add nixpacks.toml
            echo "issue_fixed=true" >> $GITHUB_OUTPUT
          fi

          # Check railway.toml configuration
          if [ -f "railway.toml" ]; then
            echo "âœ… railway.toml exists"
            # Remove conflicting buildCommand if present
            if grep -q "buildCommand" railway.toml; then
              echo "âš ï¸  Found conflicting buildCommand - fixing..."
              sed -i '/^buildCommand/d' railway.toml
              git add railway.toml
              echo "issue_fixed=true" >> $GITHUB_OUTPUT
            fi
          fi

          # Verify Prisma setup
          if [ ! -f "prisma/schema.prisma" ]; then
            echo "âŒ Prisma schema not found!"
            exit 1
          fi

          # Check for .env.example
          if [ ! -f ".env.example" ]; then
            echo "âš ï¸  .env.example missing - creating..."
            cat > .env.example << 'ENVEOF'
DATABASE_URL=postgresql://user:password@localhost:5432/zirakbook
JWT_SECRET=your-secret-key-here
JWT_EXPIRY=7d
PORT=8020
NODE_ENV=production
REDIS_URL=redis://localhost:6379
ENVEOF
            git add .env.example
            echo "issue_fixed=true" >> $GITHUB_OUTPUT
          fi

          cd ..

      - name: Fix Frontend Configuration
        id: frontend-diagnosis
        run: |
          echo "ðŸ” Checking frontend configuration..."

          # Ensure package.json has correct scripts
          if [ -f "package.json" ]; then
            echo "âœ… Frontend package.json exists"
          fi

          # Check for vite.config.js
          if [ ! -f "vite.config.js" ]; then
            echo "âš ï¸  vite.config.js missing - creating basic config..."
            cat > vite.config.js << 'VITEEOF'
import { defineConfig } from 'vite'

export default defineConfig({
  build: {
    outDir: 'dist',
    sourcemap: false,
    minify: 'esbuild',
  },
  server: {
    port: 3000,
  },
})
VITEEOF
            git add vite.config.js
            echo "issue_fixed=true" >> $GITHUB_OUTPUT
          fi

      - name: Update package.json with Railway-compatible scripts
        run: |
          cd backend

          # Ensure correct scripts exist
          if ! grep -q '"postinstall"' package.json; then
            echo "âš ï¸  Adding postinstall script for Prisma..."
            npm pkg set scripts.postinstall="prisma generate"
            git add package.json
          fi

          cd ..

      - name: Commit fixes
        id: commit
        run: |
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "fix(deploy): Auto-fix deployment configuration

ðŸ¥ Deployment Doctor applied fixes:
- âœ… Created/updated nixpacks.toml
- âœ… Fixed railway.toml conflicts
- âœ… Added missing configuration files
- âœ… Updated package.json scripts

This commit should resolve Railway deployment issues.

ðŸ¤– Auto-generated by Deployment Doctor"

            git push origin main
            echo "fixes_applied=true" >> $GITHUB_OUTPUT
            echo "âœ… Fixes committed and pushed"
          else
            echo "fixes_applied=false" >> $GITHUB_OUTPUT
            echo "âœ… No fixes needed"
          fi

      - name: Trigger Railway Deployment
        if: steps.commit.outputs.fixes_applied == 'true'
        run: |
          echo "ðŸš€ Triggering Railway deployment..."
          echo "Deployment will start automatically via Railway's GitHub integration"

      - name: Summary
        run: |
          echo "## Deployment Doctor Summary"
          echo ""
          if [ "${{ steps.commit.outputs.fixes_applied }}" == "true" ]; then
            echo "âœ… Issues detected and fixed!"
            echo "ðŸš€ Railway should redeploy automatically"
          else
            echo "âœ… No issues found - deployment configuration is correct"
          fi
